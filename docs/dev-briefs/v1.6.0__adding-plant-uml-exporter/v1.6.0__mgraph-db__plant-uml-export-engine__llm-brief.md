# LLM Briefing: MGraph-DB PlantUML Export Engine

## Purpose of This Document

This briefing is written **for an LLM that will implement and maintain** a new **PlantUML export engine** for **MGraph-DB**, using the existing DOT exporter as the architectural reference and **strictly following OSBot-Utils Type_Safe and formatting rules**.

The goal is to:

* Add a first‑class `PlantUML` exporter
* Preserve MGraph-DB architectural patterns
* Enforce Type_Safe primitives and schemas
* Avoid DOT‑specific assumptions
* Enable future *semantic* visualisations (schema views, legends, notes)

This document is authoritative: when in doubt, follow this briefing over ad‑hoc decisions.

---

## High‑Level Architecture

### Exporter Pattern (Canonical)

MGraph-DB exporters follow a **four‑layer pattern**:

```
MGraph__Export__X
 ├── models/   (Type_Safe configuration objects)
 ├── render/   (renderers & format generators)
 ├── utils/    (optional helpers)
 └── __init__
```

The **PlantUML exporter MUST mirror the DOT exporter layout** to preserve discoverability and cognitive symmetry.

Target location:

```
mgraph_db/mgraph/actions/exporters/plantuml/
```

---

## Key Design Principle (Critical)

### DOT vs PlantUML Mental Model

| DOT             | PlantUML            |
| --------------- | ------------------- |
| Attribute‑based | Statement‑based     |
| Layout‑driven   | Semantics‑driven    |
| Numeric tuning  | Visual storytelling |

**Do NOT port DOT logic blindly.**

DOT renderers emit *fragments of attributes*.

PlantUML renderers emit **complete statements**:

```
rectangle "Label" as node_id #LightBlue
node_a --> node_b : predicate
```

This changes *how renderers work*, **not** the orchestration logic.

---

## Required Classes

### 1. Orchestrator

`MGraph__Export__PlantUML`

**Responsibilities**:

* Inherits from `MGraph__Export__Base`
* Owns config + renderers
* Creates node/edge context entries
* Assembles final `@startuml … @enduml` output

Must mirror `MGraph__Export__Dot` structure and method names where possible.

---

### 2. Config Models (Type_Safe)

All config objects **MUST inherit from `Type_Safe`**.

#### Required Config Classes

* `PlantUML__Config`
* `PlantUML__Config__Graph`
* `PlantUML__Config__Node`
* `PlantUML__Config__Edge`
* `PlantUML__Config__Display`

#### Forbidden

❌ Raw primitives (`str`, `int`, `float`) in configs
❌ DOT‑only layout fields (ranksep, splines, epsilon)

#### Preferred Safe Types

| Concept   | Safe Type                           |
| --------- | ----------------------------------- |
| IDs       | `Safe_Str__Id`                      |
| Labels    | `Safe_Str__Label`                   |
| Colors    | `Safe_Str__Hex_Color` (or Safe_Str) |
| Direction | `Enum` or `Literal["TB","LR"]`      |

---

### 3. Render Layer

#### Base Class

`PlantUML__Base`

* Inherits from `Type_Safe`
* Holds `graph`, `config`, `resolver`
* Provides helpers:

  * `safe_id()`
  * `wrap_text()`
  * `type_name__from__type()`

---

### 4. Node Renderer

`PlantUML__Node__Renderer`

**Core rule**: one node → one PlantUML statement.

Responsibilities:

* Resolve node label (value / type / id)
* Resolve shape (`rectangle`, `component`, `node`)
* Resolve color (type‑based, value‑based)
* Return a **single statement string**

Output example:

```
rectangle "user_id: 123" as n_123 #LightBlue
```

---

### 5. Edge Renderer

`PlantUML__Edge__Renderer`

Responsibilities:

* Resolve source/target ids
* Resolve predicate/type label
* Emit directional PlantUML edge

Output example:

```
n_123 --> n_456 : owns
```

Advanced arrows (`o--`, `<|--`, `..>`) can be added later.

---

### 6. Format Generator

`PlantUML__Format__Generator`

Responsibilities:

* Emit `@startuml`
* Emit graph‑level directives
* Emit `@enduml`

Supported features (v1):

* Direction (`left to right direction`)
* Title
* Background color

---

## Context Handling (Critical)

The exporter **MUST reuse** the existing `MGraph__Export__Base` context mechanism:

```
self.context.nodes
self.context.edges
```

Each entry stores **fully rendered statements**, not fragments.

---

## Callbacks (Must Be Preserved)

The DOT exporter supports:

```python
on_add_node(node, node_data)
on_add_edge(edge, from_node, to_node, edge_data)
```

The PlantUML exporter **MUST keep these hooks**.

Why:

* Enables Jira‑style semantic overlays
* Enables external view logic
* Enables post‑processing without forking renderers

---

## Type_Safe Rules (MANDATORY)

### Absolute Rules

* All schema/config classes inherit from `Type_Safe`
* NO raw `str`, `int`, `float` for domain concepts
* NO mutable defaults
* NO docstrings
* Inline comments only, aligned

### Formatting Rules

* Vertical alignment on `:` and `=`
* Constructor calls aligned
* Imports vertically aligned
* Return annotations aligned with parameters

Violation of these rules is considered **incorrect output**.

---

## Safe Primitive Usage Guidance

### Node & Edge IDs

Use:

* `Safe_Str__Id`
* OR `Safe_Id`

Never use raw strings for identifiers.

---

### Labels

Use:

* `Safe_Str__Label` for display
* `Safe_Str__Text` for wrapped content

---

### Text Wrapping

PlantUML wrapping is semantic, not layout‑driven.

Prefer:

```
"line1\nline2"
```

Wrap width controlled by config (`wrap_at`).

---

## Explicit Non‑Goals (v1)

❌ PNG rendering
❌ PlantUML server integration
❌ DOT‑level layout tuning
❌ Subgraph clustering

These may come later.

---

## Migration Strategy (DOT → PlantUML)

| DOT Concept | PlantUML Mapping |
| ----------- | ---------------- |
| Node attrs  | Node statement   |
| Edge attrs  | Edge statement   |
| Styles      | Colors + shape   |
| rankdir     | direction        |

Reuse **resolver, index, and display logic**.

Do NOT reuse DOT attribute strings.

---

## Testing Expectations

Minimal tests should assert:

* Output starts with `@startuml`
* Output ends with `@enduml`
* Node count == context nodes
* Edge count == context edges
* Safe types preserved after JSON round‑trip

---

## Mental Model for the LLM

Think of this exporter as:

> "A semantic projection of MGraph structure into a visual DSL"

NOT as a layout engine.

NOT as a DOT clone.

---

## Authoritative References

* MGraph-DB DOT exporter (architecture baseline)
* OSBot‑Utils Type_Safe primitives & rules fileciteturn1file0
* OSBot‑Utils Type_Safe formatting guidance fileciteturn1file1

---

## Final Instruction to the LLM

When implementing:

1. Copy structure, not code, from DOT exporter
2. Emit **complete PlantUML statements**, never fragments
3. Use Safe primitives everywhere
4. Preserve callbacks
5. Prefer semantic clarity over visual density

If a choice exists:

> choose **Type_Safe correctness** over convenience
